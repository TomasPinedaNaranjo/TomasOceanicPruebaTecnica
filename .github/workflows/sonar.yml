name: SonarQube Analysis

on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  sonar-analysis:
    name: ğŸ” AnÃ¡lisis de SonarQube
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Necesario para anÃ¡lisis de SonarQube
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock requests-mock
    
    - name: ğŸ§ª Ejecutar pruebas con cobertura
      run: |
        pytest tests/ --cov=. --cov-report=xml --cov-report=html --junitxml=test-results.xml -v
    
    - name: ğŸ” Ejecutar anÃ¡lisis de SonarQube
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        # Instalar SonarQube Scanner
        wget -q https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.8.0.2856-linux.zip
        unzip -q sonar-scanner-cli-4.8.0.2856-linux.zip
        export PATH=$PATH:./sonar-scanner-4.8.0.2856-linux/bin
        
        # Configurar variables para PR vs Push
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          SONAR_PR_MODE="preview"
          SONAR_PR_KEY="${{ github.event.pull_request.number }}"
          SONAR_PR_BRANCH="${{ github.head_ref }}"
          SONAR_PR_BASE="${{ github.base_ref }}"
        else
          SONAR_PR_MODE="publish"
        fi
        
        # Ejecutar anÃ¡lisis
        sonar-scanner \
          -Dsonar.projectKey=mars-weather-monitor \
          -Dsonar.organization=tu-organizacion \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.token=$SONAR_TOKEN \
          -Dsonar.python.coverage.reportPaths=coverage.xml \
          -Dsonar.python.xunit.reportPath=test-results.xml \
          -Dsonar.qualitygate.wait=true \
          -Dsonar.analysis.mode=$SONAR_PR_MODE \
          -Dsonar.pullrequest.key=$SONAR_PR_KEY \
          -Dsonar.pullrequest.branch=$SONAR_PR_BRANCH \
          -Dsonar.pullrequest.base=$SONAR_PR_BASE \
          -Dsonar.sources=. \
          -Dsonar.exclusions="**/__pycache__/**,**/venv/**,**/env/**,**/sonar-env/**,**/.github/**,**/tests/**,**/htmlcov/**,**/*.db,**/node_modules/**" \
          -Dsonar.python.version=3.11 \
          -Dsonar.cpd.python.minimumtokens=100 \
          -Dsonar.python.complexity.threshold=10 \
          -Dsonar.python.lines.threshold=1000

    - name: ğŸ“Š Comentar en PR con resultados
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const { data: comments } = await github.rest.issues.listComments({
            owner: context.repo.owner,
            repo: context.repo.repo,
            issue_number: context.issue.number,
          });
          
          const botComment = comments.find(comment => 
            comment.user.type === 'Bot' && comment.body.includes('SonarQube')
          );
          
          const commentBody = `## ğŸ” AnÃ¡lisis de SonarQube Completado
          
          El anÃ¡lisis de calidad de cÃ³digo se ha ejecutado exitosamente.
          
          ğŸ“Š **Resultados:**
          - âœ… AnÃ¡lisis completado
          - ğŸ“ˆ Cobertura de cÃ³digo generada
          - ğŸ” Issues detectados y reportados
          
          ğŸ“‹ **Detalles del anÃ¡lisis:**
          - **Proyecto:** mars-weather-monitor
          - **Branch:** ${{ github.head_ref }}
          - **Base:** ${{ github.base_ref }}
          - **Modo:** Preview
          
          ğŸ”— **Ver resultados completos:** [SonarCloud](https://sonarcloud.io/dashboard?id=mars-weather-monitor)
          
          ---
          *Este comentario se actualiza automÃ¡ticamente con cada push al PR.*`;
          
          if (botComment) {
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: botComment.id,
              body: commentBody
            });
          } else {
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
          }

