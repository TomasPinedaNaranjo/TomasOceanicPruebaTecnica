name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

jobs:
  # Job 1: Pruebas unitarias
  test:
    name: ğŸ§ª Ejecutar Pruebas Unitarias
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Necesario para SonarQube
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock requests-mock
    
    - name: ğŸ§ª Ejecutar pruebas unitarias
      run: |
        pytest tests/ --cov=. --cov-report=xml --cov-report=html --junitxml=test-results.xml -v
    
    - name: ğŸ“Š Subir reporte de cobertura
      uses: codecov/codecov-action@v3
      if: success()
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: ğŸ“ Subir artefactos de pruebas
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: test-results
        path: |
          test-results.xml
          htmlcov/
          coverage.xml

  # Job 2: AnÃ¡lisis de calidad con SonarQube
  sonar:
    name: ğŸ” AnÃ¡lisis de Calidad (SonarQube)
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock requests-mock
    
    - name: ğŸ§ª Ejecutar pruebas para SonarQube
      run: |
        pytest tests/ --cov=. --cov-report=xml --junitxml=test-results.xml -v
    
    - name: ğŸ“¥ Descargar artefactos de pruebas
      uses: actions/download-artifact@v3
      with:
        name: test-results
        path: ./
    
    - name: ğŸ” Ejecutar anÃ¡lisis de SonarQube
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        # Instalar SonarQube Scanner
        wget https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-4.8.0.2856-linux.zip
        unzip sonar-scanner-cli-4.8.0.2856-linux.zip
        export PATH=$PATH:./sonar-scanner-4.8.0.2856-linux/bin
        
        # Ejecutar anÃ¡lisis
        sonar-scanner \
          -Dsonar.projectKey=mars-weather-monitor \
          -Dsonar.organization=tu-organizacion \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.token=$SONAR_TOKEN \
          -Dsonar.python.coverage.reportPaths=coverage.xml \
          -Dsonar.python.xunit.reportPath=test-results.xml \
          -Dsonar.qualitygate.wait=true

  # Job 3: AnÃ¡lisis de seguridad
  security:
    name: ğŸ”’ AnÃ¡lisis de Seguridad
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install bandit safety
    
    - name: ğŸ”’ AnÃ¡lisis de seguridad con Bandit
      run: |
        bandit -r . -f json -o bandit-report.json || true
        bandit -r . -f txt
    
    - name: ğŸ›¡ï¸ Verificar vulnerabilidades con Safety
      run: |
        safety check --json --output safety-report.json || true
        safety check
    
    - name: ğŸ“ Subir reportes de seguridad
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json

  # Job 4: Linting y formateo
  lint:
    name: ğŸ§¹ Linting y Formateo
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Instalar herramientas de linting
      run: |
        python -m pip install --upgrade pip
        pip install flake8 black isort mypy
    
    - name: ğŸ§¹ Verificar formateo con Black
      run: |
        black --check --diff .
    
    - name: ğŸ“‹ Verificar orden de imports con isort
      run: |
        isort --check-only --diff .
    
    - name: ğŸ” Linting con Flake8
      run: |
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    
    - name: ğŸ”¬ VerificaciÃ³n de tipos con MyPy
      run: |
        mypy . --ignore-missing-imports || true

  # Job 5: Build y validaciÃ³n
  build:
    name: ğŸ—ï¸ Build y ValidaciÃ³n
    runs-on: ubuntu-latest
    needs: [test, lint, security]
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
    
    - name: ğŸ“¦ Instalar dependencias
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸ—ï¸ Validar sintaxis de Python
      run: |
        python -m py_compile *.py
        find . -name "*.py" -exec python -m py_compile {} \;
    
    - name: ğŸ“‹ Verificar estructura del proyecto
      run: |
        echo "âœ… Estructura del proyecto validada"
        ls -la
        echo "ğŸ“ Archivos Python encontrados:"
        find . -name "*.py" -not -path "./.github/*" -not -path "./venv/*" -not -path "./env/*"

  # Job 6: Notificaciones
  notify:
    name: ğŸ“¢ Notificaciones
    runs-on: ubuntu-latest
    needs: [test, sonar, security, lint, build]
    if: always()
    
    steps:
    - name: ğŸ“¢ Notificar resultado del pipeline
      run: |
        if [ "${{ needs.test.result }}" == "success" ] && [ "${{ needs.lint.result }}" == "success" ] && [ "${{ needs.build.result }}" == "success" ]; then
          echo "âœ… Pipeline completado exitosamente"
          echo "ğŸ§ª Pruebas: ${{ needs.test.result }}"
          echo "ğŸ” SonarQube: ${{ needs.sonar.result }}"
          echo "ğŸ”’ Seguridad: ${{ needs.security.result }}"
          echo "ğŸ§¹ Linting: ${{ needs.lint.result }}"
          echo "ğŸ—ï¸ Build: ${{ needs.build.result }}"
        else
          echo "âŒ Pipeline fallÃ³"
          echo "ğŸ§ª Pruebas: ${{ needs.test.result }}"
          echo "ğŸ” SonarQube: ${{ needs.sonar.result }}"
          echo "ğŸ”’ Seguridad: ${{ needs.security.result }}"
          echo "ğŸ§¹ Linting: ${{ needs.lint.result }}"
          echo "ğŸ—ï¸ Build: ${{ needs.build.result }}"
          exit 1
        fi

